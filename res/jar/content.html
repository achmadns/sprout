[[ package gen;

import java.util.*;
import java.net.*;

import se.rupy.http.*;
import se.rupy.memory.*;
import se.rupy.sprout.*;
import se.rupy.content.*;

public class content extends Sprout {
	public String path() { return "/content"; }
	public void filter(Event event) throws Event, Exception {
		Output out = event.output();
		event.query().parse();
		
		int total = 5;
		Iterator articles = null;
		long max = Article.MAX;
		int page = event.query().medium("page", 0);

		Object key = event.session().get("key");
		String query = event.string("query");
		
		if(query.length() > 0) {
			articles = Article.query(query, page, total).iterator();
			max = Article.max(query);
		}
		else {
			articles = Article.get("article", page, total).iterator();
		}
		
		while(articles.hasNext()) {
			Article article = (Article) articles.next();
			Node node = (Node) article.child(USER).getFirst();
			int permit = article.permit(key); ]]

    <div class="main">
      <table width="100">
        <tr>
          <td colspan="2"><a class="title" href="article?id=[[ article.getId() ]]">[[ article.meta(ARTICLE_TITLE).getValue() ]]</a></td>
        </tr>
        <tr>
          <td><i>[[ article.time() ]]</i></td>
          <td align="right"><img src="res/comment.gif">&nbsp;<i>[[ article.comments ]]</i>&nbsp;[[ i18n("Comments") ]]</td>
        </tr>
        <tr>
          <td colspan="2">

[[ print(article, out); ]]

          </td>
        </tr>
        <tr>
          <td colspan="2">/[[ node.meta(USER_NAME).getValue() ]]</td>
        </tr>
        
[[			if(permit > 0) { ]]
        
        <tr>
          <td colspan="2">

            <a href="/edit?id=[[ article.getId() ]]" class="button">
              <span>[[ i18n("Edit") ]]</span>
            </a>

            <a href="/delete?id=[[ article.getId() ]]" class="button" onclick="return confirm('[[ i18n("Are you sure you want to delete the article?") ]]');">
              <span>[[ i18n("Delete") ]]</span>
            </a>
            
          </td>
        </tr>
        
[[			} ]]
        
      </table>
    </div>

[[ 		} ]]

    <span class="clear"></span>
    <div style="float: left;">
      <form name="query" action="" method="get">
        <table border="0" width="100">
          <tr>
            <td>
              <input type="text" class="small" name="query" value="[[ event.string("query") ]]"/>
            </td>
            <td>
              <a href="" class="arrow" onclick="document.query.submit(); return false;">
                <span>[[ i18n("Search") ]]</span>
              </a>
            </td>
          </tr>
        </table>
      </form>
    </div>

[[		if(max > total) { ]]

    <div style="float: right;">
      <table>
        <tr>
          <td>

[[			int first = page > 2 ? page - 2 : 0;
			int last = (int) (max / total) + (max % total > 0 ? 1 : 0);
			int start = last < first + 5 && last > 5 ? last - 5 : first;
			int length = last > first + 5 ? first + 5 : last;

			if(first > 0) { ]]

            <a href="/?query=[[ URLEncoder.encode(query, "UTF-8") ]]&page=0" title="[[ Sprout.i18n("First Page") ]]">&laquo;</a>

[[			}
			for(int j = start; j < length; j++) {
				if(page == j) { ]]

            [[ (j + 1) ]]

[[				}
				else { ]]

            <a href="/?query=[[ URLEncoder.encode(query, "UTF-8") ]]&page=[[ j ]]" title="[[ Sprout.i18n("Go to page") ]]&nbsp;[[ j + 1 ]]">[[ (j + 1) ]]</a>

[[				}
			}
			if(last > length) { ]]

            <a href="/?query=[[ URLEncoder.encode(query, "UTF-8") ]]&page=[[ (last - 1) ]]" title="[[ Sprout.i18n("Last page") ]]">&raquo;</a>

[[			} ]]

          </td>
        </tr>
      </table>
    </div>
    
[[		} ]]

[[	}
	static void print(Article article, Output out) throws Exception {
		Iterator it = article.child(FILE).iterator();
		while(it.hasNext()) {
			Node file = (Node) it.next();
			Data name = file.meta(FILE_NAME);
			Data type = file.meta(FILE_TYPE);
				
			if(type != null) {
				if(type.getValue().equals("IMAGE")) { ]]

          <div>
            <a class="title" href="article?id=[[ article.getId() ]]"><img src="[[ file.path() + "SMALL_" + name.getValue() ]]" border="0"/></a>
          </div>

[[				} else if(type.getValue().equals("AUDIO")) { ]]

          <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" height="30" width="200">
            <param name="movie" value="audio.swf?audio_file=[[ URLEncoder.encode(file.path() + name.getValue(), "UTF-8") ]]&color=E4E4E4" />
            <embed src="audio.swf?audio_file=[[ URLEncoder.encode(file.path() + name.getValue(), "UTF-8") ]]&color=E4E4E4" height="30" width="200" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" />
          </object>

[[				}

System.out.println(type.getValue());

				break;
			}
		}

		LinkedList columns = article.columnize();
		it = columns.iterator();
		if(it.hasNext()) {
			String column = (String) it.next(); ]]

          <div class="column">
            [[ column ]]
            [[ if(columns.size() > 1) { ]]
            [[ out.print("&#8230;"); ]]
			[[ } ]]
          </div>

[[		}
	}
} ]]

