[[ package gen;

import java.util.*;

import se.rupy.http.*;
import se.rupy.memory.*;
import se.rupy.sprout.*;
import se.rupy.content.*;

import se.rupy.util.*;

public class article extends Sprout {
	public String path() { return "/article"; }
	public void filter(Event event) throws Event, Exception {
		event.query().parse();
		Output out = event.output();
		Object key = event.session().get("key");
		Article article = Article.find(event.big("id"));
		Node user = (Node) article.child(USER).getFirst();
		boolean edit = user.meta(USER_KEY).getValue().equals(key);
		int permit = article.permit(key); ]]

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Sprout</title>
  <link rel="stylesheet" type="text/css" href="res/sprout.css">
  <script type="text/javascript" src="res/sprout.js"></script>
</head>
<body>
<div id="page" style="padding: 10px 10px 10px 10px;">
  <div>
    <table>
      <tr>
        <td colspan="2" class="title">[[ article.meta(ARTICLE_TITLE).getValue() ]]</td>
      </tr>
      <tr>
        <td colspan="2"><i>[[ article.time() ]]</i></td>
      </tr>
      <tr>
        <td colspan="2">
        
[[			Iterator it = article.child(FILE).iterator();
			while(it.hasNext()) {
				Node file = (Node) it.next();
				Data name = file.meta(FILE_NAME);
				Data type = file.meta(FILE_TYPE);
				
				if(type != null) {
					if(type.getValue().equals("IMAGE")) { ]]

          <div class="big">
            <a href="[[ file.path() + name.getValue() ]]">
            <img src="[[ file.path() + "BIG_" + name.getValue() ]]" border="0"/>
            </a>
          </div>

[[ 					}
					else if(type.getValue().equals("VIDEO")) {
						String tmp = name.getValue();
						String flv = tmp.substring(0, tmp.indexOf('.')); ]]

          <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="320" height="280" id="player" align="middle">
            <param name="allowScriptAccess" value="sameDomain" />
            <param name="allowFullScreen" value="true" />
            <param name="movie" value="player.swf?source=[[ file.encoded() + flv + ".flv" ]]" />
            <param name="quality" value="high" />
            <param name="bgcolor" value="#ffffff" />
            <embed src="player.swf?source=[[ file.encoded() + flv + ".flv" ]]" quality="high" bgcolor="#ffffff" width="320" height="280" name="player" align="middle" allowScriptAccess="sameDomain" allowFullScreen="true" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" />
          </object>

[[					}
				}
			}

			LinkedList columns = article.columnize();
			it = columns.iterator();
			while(it.hasNext()) {
				String column = (String) it.next(); ]]

          <div class="column">
            [[ column ]]
          </div>

[[			} ]]

        </td>
      </tr>
      <tr>
        <td colspan="2">/[[ user.meta(USER_NAME).getValue() ]]</td>
      </tr>
      
[[		LinkedList comments = article.child(COMMENT); ]]
      
      <tr>
        <td colspan="2"><img src="res/comment.gif">&nbsp;<i>[[ article.comments ]]</i>&nbsp;[[ i18n("Comments") ]]</td>
      </tr>
      
[[		it = comments.iterator();
		while(it.hasNext()) {
			Node comment = (Node) it.next();
			Data ip = comment.meta(COMMENT_IP);
			Data state = comment.meta(COMMENT_STATE);
			
            boolean show = (state == null ? false : state.getValue().equals("SHOW"));
            
            if(ip == null) {
            	ip = ((Node) comment.child(USER).getFirst()).meta(USER_IP);
            } ]]
      
[[			if(permit > 0) { ]]

      <tr>      
        <td>[[ comment.meta(COMMENT_BODY).getValue() ]]</td>
        <td>
          <a href="/[[ show ? "hide" : "show" ]]?id=[[ article.getId() ]]&comment=[[ comment.getId() ]]" class="button">
            <span>[[ i18n(show ? "Hide" : "Show") ]]</span>
          </a>
        </td>
      </tr>
      <!-- [[ Ip.reverse(ip.getValue()) ]] -->
        
[[			} else if(show) { ]]

      <tr>
        <td colspan="2">[[ comment.meta(COMMENT_BODY).getValue() ]]</td>
      </tr>
      
[[			} ]]
        
[[ 		} ]]
      
    </table>
  </div>
  <div style="float: left; padding-right: 10px; padding-bottom: 10px;">
    <table border="0" width="100">
      <form name="comment" action="comment" method="post">
        <input type="hidden" name="id" value="[[ article.getId() ]]"/>
        
[[		if(event.string("error").length() > 0) { ]]

        <tr>
          <td colspan="2">
            <font color="red"><i>[[ event.string("error") ]]</i></font>
          </td>
        </tr>

[[		} ]]

        <tr>
          <td colspan="2">
            <textarea class="large" name="body" rows="5" tabindex="2">[[ event.string("body") ]]</textarea>
          </td>
        </tr>
        <tr>
          <td colspan="2">
            <a href="" class="arrow" onclick="document.comment.submit(); return false;">
              <span>[[ i18n("Post") ]]</span>
            </a>
          </td>
        </tr>
      </form>
    </table>
  </div>
</div>
</body>
</html>

[[ } 
} ]]

