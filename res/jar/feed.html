[[ package gen;

import java.util.*;

import se.rupy.http.*;
import se.rupy.memory.*;
import se.rupy.sprout.*;
import se.rupy.content.*;

public class feed extends Sprout {
	public String path() { return "/feed"; }
	public void filter(Event event) throws Event, Exception {
		event.query().parse();
		event.reply().type("text/xml");
		Output out = event.output();
		Object key = event.session().get("key");
		LinkedList list = Article.get("article", 0, 5);
		Iterator it = list.iterator(); ]]

<?xml version="1.0" encoding="utf-8"?>

[[		if(event.bit("atom")) { ]]

<feed xmlns="http://www.w3.org/2005/Atom">
	<title>Sprout</title>
	<subtitle>Sprout</subtitle>
	<link href="http://[[ User.host ]]/feed" rel="self" />
	<link href="http://[[ User.host ]]" />
	<id>urn:uuid:1234</id>
	<updated></updated>
	<author>
		<name></name>
		<email></email>
	</author>

[[			while(it.hasNext()) {
				Article article = (Article) it.next();
				Node user = (Node) article.child(USER).getFirst();
				boolean edit = user.meta(USER_KEY).getValue().equals(key); ]]

	<entry>
		<title>[[ clean(article.meta(ARTICLE_TITLE).getValue()) ]]</title>
		<link href="http://[[ User.host ]]/article?id=[[ article.getId() ]]" />
		<id>urn:uuid:[[ article.getId() ]]</id>
		<updated>[[ clean(article.time()) ]]</updated>
		<summary>[[ print(User.host, article, out); ]]</summary>
	</entry>

[[ 			} ]]

</feed>

[[		} else if(event.bit("rss")) { ]]

<rss version="2.0">
  <channel>
    <title>Sprout</title>
    <link>http://[[ User.host ]]</link>
    <description>Sprout</description>
    
[[			while(it.hasNext()) {
				Article article = (Article) it.next();
				Node user = (Node) article.child(USER).getFirst();
				boolean edit = user.meta(USER_KEY).getValue().equals(key); ]]
		
    <item>
      <title>[[ clean(article.meta(ARTICLE_TITLE).getValue()) ]]</title>
      <link>http://[[ User.host ]]/article?id=[[ article.getId() ]]</link>
      <description>[[ print(User.host, article, out); ]]</description>
      <pubDate>[[ clean(article.time()) ]]</pubDate>
    </item>

[[ 			} ]]

  </channel>
</rss>

[[		} else { ]]

<data>
  <host>[[ User.host ]]</host>

[[			while(it.hasNext()) {
				Article article = (Article) it.next();
				Node user = (Node) article.child(USER).getFirst();
				boolean edit = user.meta(USER_KEY).getValue().equals(key); ]]

  <item>
    <head>[[ clean(article.meta(ARTICLE_TITLE).getValue()) ]]</head>
    <link>
      <html>/article?id=[[ article.getId() ]]</html>
      <json>/article?id=[[ article.getId() ]]&amp;json=true</json>
    </link>
    <body>[[ clean(article.meta(ARTICLE_BODY).getValue()) ]]</body>
    <date>[[ article.getDate() ]]</date>
    
[[				LinkedList children = article.child(ALL);
				Iterator it2 = children.iterator();
				while(it2.hasNext()) {
					Node child = (Node) it2.next();
					switch(child.getType()) {
						case USER: { ]]

    <user>[[ child.meta(USER_NAME).getValue() ]]</user>

[[						} break;
						case COMMENT: { 
							Data state = child.meta(COMMENT_STATE);
							boolean show = (state == null ? false : state.getValue().equals("SHOW"));
							if(show) { ]]

    <post>[[ child.meta(COMMENT_BODY).getValue() ]]</post>

[[							}
						} break;
						case FILE: { ]]

    <file>
      <type>[[ child.meta(FILE_TYPE).getValue() ]]</type>
      <path>[[ child.path() + clean(child.meta(FILE_NAME).getValue()) ]]</path>
    </file>
    
[[						} break;
						case PING: {
							Data state = child.meta(PING_STATE);
							boolean show = (state == null ? false : state.getValue().equals("SHOW"));
							if(show) { ]]

    <ping>[[ clean(child.meta(PING_URL).getValue()) ]]</ping>

[[							}
						} break;
					}
				} ]]

  </item>

[[ 			} ]]

</data>

[[		}
	}

	static void print(String host, Article article, Output out) throws Exception {
		Iterator it = article.child(FILE).iterator();
		while(it.hasNext()) {
			Node file = (Node) it.next();
			Data type = file.meta(FILE_TYPE);
            
            if(type != null && type.getValue().equals("IMAGE")) {
				out.println(clean("<img src=\"http://" + host + file.path() + "SMALL_" + file.meta(FILE_NAME).getValue() + "\" align=\"right\"/>"));
				break;
			}
		}

		LinkedList columns = article.columnize();
		it = columns.iterator();
		if(it.hasNext()) {
			String column = (String) it.next();
            out.print(clean(column));
			if(columns.size() > 1) {
				out.println("&#8230;");
			}
			else {
				out.println("");
			}
		}
	}
} ]]

