[[ package gen;

import java.util.*;

import se.rupy.http.*;
import se.rupy.memory.*;
import se.rupy.sprout.*;
import se.rupy.content.*;

public class feed extends Sprout {
	public String path() { return "/feed"; }
	public void filter(Event event) throws Event, Exception {
		event.reply().type("text/xml");
		Output out = event.output();
		Object key = event.session().get("key");
		LinkedList list = Article.get("article", 0, 5);
		Iterator it = list.iterator(); ]]

<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
  <channel>
    <title>Sprout</title>
    <link>http://[[ User.host ]]</link>
    <description>Blog/Community/CMS Lite</description>
    
[[		while(it.hasNext()) {
			Article article = (Article) it.next();
			Node user = (Node) article.child(USER).getFirst();
			boolean edit = user.meta(USER_KEY).getValue().equals(key); ]]
		
    <item>
      <title>[[ article.meta(ARTICLE_TITLE).getValue() ]]</title>
      <link>http://[[ User.host ]]/article?id=[[ article.getId() ]]</link>
      <description>[[ print(User.host, article, out); ]]</description>
      <pubDate>[[ clean(article.time()) ]]</pubDate>
    </item>

[[ 		} ]]

  </channel>
</rss>

[[	}

	static void print(String host, Article article, Output out) throws Exception {
		Iterator it = article.child(FILE).iterator();
		while(it.hasNext()) {
			Node file = (Node) it.next();
			
			if(file.meta(FILE_TYPE).getValue().equals("IMAGE")) {
				out.println(clean("<img src=\"http://" + host + file.path() + "SMALL_" + file.meta(FILE_NAME).getValue() + "\" align=\"right\"/>"));
				break;
			}
		}

		LinkedList columns = article.columnize();
		it = columns.iterator();
		if(it.hasNext()) {
			String column = (String) it.next();
            out.print(clean(column));
			if(columns.size() > 1) {
				out.println("&#8230;");
			}
			else {
				out.println("");
			}
		}
	}
} ]]

