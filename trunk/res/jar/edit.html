[[ package gen;

import java.util.*;

import se.rupy.http.*;
import se.rupy.memory.*;
import se.rupy.sprout.*;

public class edit extends Sprout {
	public int index() { return 3; }
	public String path() { return "/article/edit"; }
	public void filter(Event event) throws Event, Exception {
		Output out = event.output();
		Object key = event.session().get("key");
		Article article = Article.get(key);
		User user = User.get(key);
		
		if(event.string("title").length() == 0 && 
		   event.string("body").length() == 0) {
			Article.remove(key);
			article = null;
		} ]]

    <table border="0" width="100">
      <form name="article" action="article/edit" method="post">
        <tr>
          <td colspan="2">
          
[[		if(user != null && user.permit("ADMIN")) { ]]

            <a href="/admin" class="button">
              <span>[[ i18n("Admin") ]]</span>
            </a>

[[		} ]]
          
            <a href="/logout" class="button">
              <span>[[ i18n("Logout") ]]</span>
            </a>
          </td>
        </tr>

[[		if(event.string("error").length() > 0) { ]]

        <tr>
          <td colspan="2">
            <font color="red"><i>[[ event.string("error") ]]</i></font>
          </td>
        </tr>

[[		} ]]

        <tr>
          <td>[[ i18n("Title") ]]</td>
          <td align="right">
            <input type="text" class="large" name="title" value="[[ event.string("title") ]]" tabindex="1"/>
          </td>
        </tr>
        <tr>
          <td colspan="2">
            <textarea class="large" name="body" rows="5" tabindex="2">[[ event.string("body") ]]</textarea>
          </td>
        </tr>
        
[[		if(article != null) {
			Iterator it = article.get(FILE).iterator();
			while(it.hasNext()) {
				Node file = (Node) it.next();
				if(file.get(FILE_TYPE).getValue().equals("IMAGE")) { ]]

        <tr>
          <td colspan="2"><img src="[[ file.path() + "TINY_" + file.get(FILE_NAME).getValue() ]]" alt="[[ file.path() + file.get(FILE_NAME).getValue() ]]"/></td>
        </tr>

[[ 				}
				else if(file.get(FILE_TYPE).getValue().equals("VIDEO")) {
					String name = file.get(FILE_NAME).getValue();
					name = name.substring(0, name.indexOf('.')); ]]

        <tr>
          <td colspan="2"><img src="res/flash.gif" alt="[[ file.path() + name + ".flv" ]]"/></td>
        </tr>

[[				}
 			}
		} ]]
        
        <tr>
          <td colspan="2">
            <a href="" class="arrow" onclick="document.article.submit(); return false;">
              <span>[[ i18n("Publish") ]]</span>
            </a>
          </td>
        </tr>
      </form>
      <form enctype="multipart/form-data" name="upload" action="upload" method="POST">
        <tr>
          <td colspan="2">
            <a class="button overflow">
              <input name="file" type="file" class="file" onchange="document.upload.submit()"/>
              <span>[[ i18n("Files") ]]</span>
            </a>
          </td>
        </tr>
      </form>
      <tr>
        <td colspan="2" align="right">
          <a href="feed"><img src="res/feed.gif" border="0"></a>
        </td>
      </tr>
    </table>

[[ } 
} ]]

