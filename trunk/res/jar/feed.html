[[ package gen;

import java.util.*;

import se.rupy.http.*;
import se.rupy.memory.*;
import se.rupy.sprout.*;

public class feed extends Sprout {
	public String path() { return "/feed"; }
	public void filter(Event event) throws Event, Exception {
		event.reply().type("text/xml");
		String host = "sprout.rupy.se"; // event.query().header("host");
		Output out = event.output();
		Object key = event.session().get("key");
		LinkedList list = get("article");
		Iterator it = list.iterator(); ]]

<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
  <channel>
    <title>Sprout</title>
    <link>http://[[ host ]]</link>
    <description>Content Management System</description>
    
[[		while(it.hasNext()) {
			Article article = (Article) it.next();
			Node user = (Node) article.get(Type.USER).getFirst();
			boolean edit = user.get(Type.USER_KEY).getValue().equals(key); ]]
		
    <item>
      <title>[[ article.get(Type.ARTICLE_TITLE).getValue() ]]</title>
      <link>http://[[ host ]]/article?id=[[ article.getId() ]]</link>
      <description>[[ print(host, article, out); ]]</description>
      <pubDate>[[ article.time() ]]</pubDate>
    </item>

[[ 		} ]]

  </channel>
</rss>

[[ } 
	static String clean(String line) {
        line = line.replaceAll("<", "&lt;");
        line = line.replaceAll(">", "&gt;");
		return line;
	}
	static void print(String host, Article article, Output out) throws Exception {
		Iterator it = article.get(Type.FILE).iterator();
		if(it.hasNext()) {
			Node file = (Node) it.next();
            out.println(clean("<img src=\"http://" + host + file.get(Type.FILE_PATH).getValue() + "/SMALL_" + file.get(Type.FILE_NAME).getValue() + "\" align=\"right\"/>"));
		}

		LinkedList columns = article.columnize();
		it = columns.iterator();
		if(it.hasNext()) {
			String column = (String) it.next();
            out.print(clean(column));
			if(columns.size() > 1) {
				out.println("...");
			}
			else {
				out.println("");
			}
		}
	}
} ]]

